<!DOCTYPE html>

<html class="no-js">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title></title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.js"></script>
  <script src="https://cdn.bootcss.com/vue/2.5.17/vue.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/element-ui/2.4.9/theme-chalk/index.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/element-ui/2.4.9/index.js"></script>
  <link rel="stylesheet" href="https://cdn.bootcss.com/animate.css/3.7.0/animate.min.css" />
  <link rel="stylesheet" href="../../../lib/index.css" />
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="../../cdn/codemirror/codemirror.css" />
  <link rel="stylesheet" href="../../cdn/codemirror/theme/rubyblue.css" />
  <link rel="stylesheet" href="../../cdn/codemirror/addon/lint/lint.css" />
  <script src="../../cdn/codemirror/codemirror.js"></script>
  <script src="../../cdn/codemirror/addon/lint/lint.js"></script>
  <script src="../../cdn/codemirror/mode/javascript/javascript.js"></script>
  <script src="https://cdn.bootcss.com/echarts/4.2.1-rc1/echarts.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.19.2/vuedraggable.umd.min.js"></script>
  <script src="./js/colorOption.js"></script>
  <script src="./js/listOption.js"></script>
  <script src="./js/dicOption.js"></script>
  <script src="./js/baseList.js"></script>
  <script src="../../../lib/avue.js"></script>
</head>

<body>
  <div id="app">
    <el-dialog title="复制代码" :visible.sync="dialogVisible">
      <div class="json-editor">
        <textarea ref="code" name="code"></textarea>
      </div>
    </el-dialog>
    <el-menu mode="horizontal" background-color="#545c64" text-color="#fff" active-text-color="#ffd04b">
      <el-submenu :index="index+''" v-for="(item,index) in baseList" :key="index">
        <template slot="title">{{item.label}}</template>
        <el-menu-item @click="addCompoment(citem.option)" :index=`${index}-${cindex}`
          v-for="(citem,cindex) in item.children">{{citem.label}}</el-menu-item>
      </el-submenu>
      <el-menu-item @click="menuFlag=true" v-show="!menuFlag">还原</el-menu-item>
      <el-menu-item @click="handleView" v-show="menuFlag">预览</el-menu-item>
      <el-menu-item @click="handleBuild">生成数据</el-menu-item>

    </el-menu>
    <div class="app" :class="{'app--none':!menuFlag}">
      <div class="menu" v-show="menuFlag">
        <p class="title">图层</p>
        <draggable v-model="menuList">
          <div class="menu__item" :class="{'menu__item--active':item.index===active}" v-for="(item,index) in menuList"
            :key="index" @click="active=item.index">
            {{item.title}}
          </div>
        </draggable>
      </div>
      <div class="wrapper" ref="wrapper">
        <div class="content">
          <div class="container" :style="styleName" ref="container">
            <div class="grade" @mousedown.stop.self="handleMouseDown" v-if="gradeFlag || config.gradeShow"
              :style="gradeLenStyle"></div>
            <avue-draggable v-if="relaod" :disabled="!menuFlag" :ref="'item_'+index" :step="2" @focus="handleFocus"
              @postion="handlePostion" @resize="handleResize" @blur="handleBlur" @change="handleChange" :index="index"
              :z-index="item.zIndex" v-for="(item,index) in list" :width="item.component.width"
              :height="item.component.height" :key="index" :top="item.top" :left="item.left">
              <img v-if="['img'].includes(item.component.prop)" :src="item.data" draggable="false" />
              <div v-else-if="['text'].includes(item.component.prop)" :style="handleStyle(item)">
                {{item.data}}</div>
              <component :id="'component_'+index" v-else :is="item.component.name" :data="item.data"
                :option="item.component.option" :url="item.url" :time="item.time" :data-Type="item.dataType">
              </component>
              <div slot-scope="scope" slot="menu">
                <i class="el-icon-close" @click="handleDel(scope.index)"></i>
                <i class="el-icon-document" @click="handleCopy(scope.index)"></i>
              </div>
            </avue-draggable>
          </div>
        </div>
      </div>
      <div class="menu params" v-show="menuFlag">
        <p class="title">操作</p>
        <el-form label-width="80px">
          <el-form-item label="图层名称" v-if="![undefined].includes(activeComponent.prop)">
            <avue-input v-model="activeObj.name"></avue-input>
          </el-form-item>
          <template v-if="['flop','bar'].includes(activeComponent.prop)">
            <el-form-item label="数据类型">
              <avue-radio v-model="activeObj.dataType" :dic="dicOption.dataType"></avue-radio>
            </el-form-item>
            <el-form-item label="数据值" v-if="activeObj.dataType===0">
              <avue-input v-model="activeObj.data"></avue-input>
            </el-form-item>
            <template v-if="activeObj.dataType===1">
              <el-form-item label="接口地址">
                <avue-input v-model="activeObj.url"></avue-input>
              </el-form-item>
              <el-form-item label="刷新时间">
                <avue-input-number v-model="activeObj.time">
                </avue-input-number>
              </el-form-item>

            </template>

          </template>
          <template v-if="activeComponent.prop==='text'">
            <el-form-item label="文本内容">
              <avue-input v-model="activeObj.data"></avue-input>
            </el-form-item>
            <el-form-item label="字体大小">
              <avue-silder v-model="activeComponent.style.fontSize"></avue-silder>
            </el-form-item>
            <el-form-item label="字体颜色">
              <avue-color v-model="activeComponent.style.color"></avue-color>
            </el-form-item>
            <el-form-item label="字体背景">
              <avue-color v-model="activeComponent.style.backgroundColor"></avue-color>
            </el-form-item>
            <el-form-item label="文字粗细">
              <avue-select v-model="activeComponent.style.fontWeight" :dic="dicOption.fontWeight">
              </avue-select>
            </el-form-item>
            <el-form-item label="对齐方式">
              <avue-select v-model="activeComponent.style.textAlign" :dic="dicOption.textAlign">
              </avue-select>
            </el-form-item>
          </template>
          <template v-else-if="activeComponent.prop==='img'">
            <el-form-item label="缩略图">
              <img :src="activeObj.data" alt="" width="100%" />
            </el-form-item>
            <el-form-item label="图片地址">
              <avue-input v-model="activeObj.data"></avue-input>
            </el-form-item>
          </template>
          <template v-else-if="activeComponent.prop==='progress'">
            <el-form-item label="类型">
              <avue-radio v-model="activeComponent.option.type" :dic="dicOption.line">
                </avue-select>
            </el-form-item>
            <el-form-item label="字体大小">
              <avue-silder v-model="activeComponent.option.fontSize" :max="200"></avue-silder>
            </el-form-item>
            <el-form-item label="边框大小">
              <avue-silder v-model="activeComponent.option.strokeWidth" :max="50"></avue-silder>
            </el-form-item>
            <el-form-item label="字体颜色">
              <avue-color v-model="activeComponent.option.color"></avue-color>
            </el-form-item>
            <el-form-item label="文字粗细">
              <avue-select v-model="activeComponent.option.fontWeight" :dic="dicOption.fontWeight">
              </avue-select>
            </el-form-item>
            <el-form-item label="边框颜色">
              <avue-color v-model="activeComponent.option.borderColor"></avue-color>
            </el-form-item>
          </template>
          <template v-else-if="activeComponent.prop==='flop'">
            <el-form-item label="字体大小">
              <avue-silder v-model="activeComponent.option.fontSize" :max="200"></avue-silder>
            </el-form-item>
            <el-form-item label="字体颜色">
              <avue-color v-model="activeComponent.option.color"></avue-color>
            </el-form-item>
            <el-form-item label="字体间距">
              <avue-silder v-model="activeComponent.option.split"></avue-silder>
            </el-form-item>
            <el-form-item label="文字粗细">
              <avue-select v-model="activeComponent.option.fontWeight" :dic="dicOption.fontWeight">
              </avue-select>
            </el-form-item>
            <el-form-item label="边框">
              <avue-radio v-model="activeComponent.option.type" :dic="dicOption.border">
                </avue-select>
            </el-form-item>
            <template v-if="activeComponent.option.type==='img'">
              <el-form-item label="背景图片">
                <img :src="item" v-for="(item,index) in activeComponent.list" :key="index"
                  @click="activeComponent.option.backgroundImage=item">
              </el-form-item>
            </template>
            <template v-else-if="activeComponent.option.type==='border'">
              <el-form-item label="边框颜色">
                <avue-color v-model="activeComponent.option.borderColor"></avue-color>
              </el-form-item>
              <el-form-item label="边框宽度">
                <avue-silder v-model="activeComponent.option.borderWidth" :max="10"></avue-silder>
              </el-form-item>
            </template>
            <el-form-item label="背景颜色">
              <avue-color v-model="activeComponent.option.backgroundColor"></avue-color>
            </el-form-item>
            <el-form-item label="前缀内容">
              <avue-input v-model="activeComponent.option.prefixText"></avue-input>
            </el-form-item>
            <el-form-item label="对其方式">
              <avue-select v-model="activeComponent.option.prefixTextAlign" :dic="dicOption.textAlign">
              </avue-select>
            </el-form-item>
            <el-form-item label="间距">
              <avue-silder v-model="activeComponent.option.prefixSplit"></avue-silder>
            </el-form-item>
            <el-form-item label="颜色">
              <avue-color v-model="activeComponent.option.prefixColor"></avue-color>
            </el-form-item>
            <el-form-item label="字体大小">
              <avue-silder v-model="activeComponent.option.prefixFontSize" :max="200"></avue-silder>
            </el-form-item>
            <el-form-item label="后缀内容">
              <avue-input v-model="activeComponent.option.suffixText"></avue-input>
            </el-form-item>
            <el-form-item label="对其方式">
              <avue-select v-model="activeComponent.option.suffixTextAlign" :dic="dicOption.textAlign">
              </avue-select>
            </el-form-item>
            <el-form-item label="间距">
              <avue-silder v-model="activeComponent.option.suffixSplit"></avue-silder>
            </el-form-item>
            <el-form-item label="颜色">
              <avue-color v-model="activeComponent.option.suffixColor"></avue-color>
            </el-form-item>
            <el-form-item label="字体大小">
              <avue-silder v-model="activeComponent.option.suffixFontSize" :max="200"></avue-silder>
            </el-form-item>
          </template>
          <template v-else-if="activeComponent.prop==='bar'">
            <el-form-item label="标题">
              <avue-input type="textarea" v-model="activeComponent.option.title"></avue-input>
            </el-form-item>
            <el-form-item label="标题大小">
              <avue-silder v-model="activeComponent.option.titleFontSize"></avue-silder>
            </el-form-item>
            <el-form-item label="标题颜色">
              <avue-color v-model="activeComponent.option.titleColor"></avue-color>
            </el-form-item>
            <el-form-item label="标题对齐">
              <avue-select v-model="activeComponent.option.titlePostion" :dic="dicOption.textAlign">
              </avue-select>
            </el-form-item>
            <el-form-item label="标题隐藏">
              <avue-switch v-model="activeComponent.option.titleShow"></avue-switch>
            </el-form-item>
            <el-form-item label="标题链接">
              <avue-input type="textarea" v-model="activeComponent.option.titleLink"></avue-input>
            </el-form-item>
            <el-form-item label="文字颜色">
              <avue-color v-model="activeComponent.option.nameColor">
              </avue-color>
            </el-form-item>
            <el-form-item label="轴线颜色">
              <avue-color v-model="activeComponent.option.lineColor"></avue-color>
            </el-form-item>
            <avue-crud :option="colorOption" :data="activeComponent.option.barColor" @row-save="rowSave"
              @row-del="rowDel" @row-update="rowUpdate"></avue-crud>
          </template>
          <template v-else>
            <el-form-item label="大屏名称">
              <avue-input v-model="config.name"></avue-input>
            </el-form-item>
            <el-form-item label="大屏宽度">
              <avue-input-number v-model="config.width"></avue-input-number>
            </el-form-item>
            <el-form-item label="大屏高度">
              <avue-input-number v-model="config.height"></avue-input-number>
            </el-form-item>
            <el-form-item label="缩放比例">
              <el-slider v-model="config.scale" :max="200" :format-tooltip="formatTooltip"></el-slider>
            </el-form-item>
            <el-form-item label="缩略图">
              <img :src="config.backgroundImage" alt="" width="100%" />
            </el-form-item>
            <el-form-item label="背景图片">
              <avue-input v-model="config.backgroundImage"></avue-input>
            </el-form-item>
            <el-form-item label="显示网格">
              <avue-switch v-model="config.gradeShow"></avue-switch>
            </el-form-item>
            <el-form-item label="网格间距">
              <avue-input-number v-model="config.gradeLen"></avue-input-number>
            </el-form-item>
          </template>
        </el-form>
      </div>
    </div>
  </div>
</body>
<script>
  new Vue({
    el: '#app',
    data() {
      return {
        baseList: baseList,
        menuFlag: true,
        dialogVisible: false,
        CodeMirrorEditor: {},
        gradeFlag: false,
        relaod: true,
        form: {},
        dicOption: dicOption,
        colorOption: colorOption,
        config: {
          name: 'avuex数据大屏',
          width: 1920,
          height: 1080,
          scale: 1,
          backgroundImage: 'https://sugar.bce.baidu.com/static/img-templet/background-2.png',
          gradeShow: true,
          gradeLen: 30,
        },
        active: -1,
        menuList: [],
        list: list
      }
    },
    computed: {
      activeComponent() {
        return this.activeObj.component || {}
      },
      activeObj() {
        return this.list[this.active] || {}
      },
      styleName() {
        const scale = this.config.scale;
        return {
          transform: `scale(${scale / 100}, ${scale / 100})`,
          background: `url(${this.config.backgroundImage}) 0% 0% / 100% 100% rgb(3, 12, 59)`,
          width: this.setPx(this.config.width),
          height: this.setPx(this.config.height)
        }
      },
      gradeLenStyle() {
        return {
          backgroundSize: `${this.setPx(this.config.gradeLen)} ${this.setPx(this.config.gradeLen)},${this.setPx(this.config.gradeLen)} ${this.setPx(this.config.gradeLen)}`
        }
      }
    },
    created() {
      //初始化数据
      this.initData()
    },
    mounted() {
      this.setResize();
    },
    watch: {
      menuFlag(val) {
        this.$nextTick(() => {
          this.setResize();
        })
      },
      active(val) {
        this.list.forEach((ele, index) => {
          if (index === val) {
            this.$refs['item_' + index][0].setActive(true)
          } else {
            this.$refs['item_' + index][0].setActive(false)
          }
        });
      },
      menuList(val) {
        const leng = val.length;
        val.forEach((ele, index) => {
          this.$set(this.list, ele.index, Object.assign(ele, {
            zIndex: leng - index
          }))
        })
      }
    },
    methods: {
      setResize() {
        this.config.scale = (this.$refs.wrapper.offsetWidth / this.config.width) * 100
      },
      formatTooltip(val) {
        return parseInt(val);
      },
      handleStyle(item) {
        const style = item.component.style
        let obj = {
          padding: '10px'
        }
        Object.keys(style).forEach(ele => {
          if (['fontSize'].includes(ele)) {
            obj[ele] = style[ele] + 'px'
          } else {
            obj[ele] = style[ele]
          }

        })
        return obj;
      },
      initData() {
        this.list.forEach((ele, index) => {
          this.$set(this.list, index, Object.assign(ele, {
            index
          }));
        })

        this.menuList = [...this.list];
        this.handleListMenuSort();
      },
      handleListMenuSort() {
        function compare(propertyName) {
          return function (object1, object2) {
            var value1 = object1[propertyName];
            var value2 = object2[propertyName];
            if (value2 < value1) {
              return -1;
            } else if (value2 > value1) {
              return 1;
            } else {
              return 0;
            }
          }
        }
        this.menuList.sort(compare("zIndex"));
      },
      handleMouseDown() {
        this.active = -1;
      },
      handleChange(index) {
        this.active = index;
      },
      handleFocus() {
        this.gradeFlag = true;
      },
      handleBlur() {
        this.gradeFlag = false;
      },
      handleDel(index) {
        const obj = this.list[index]
        this.$confirm(`是否删除<<${obj.name}>>图层?`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.list.splice(index, 1);
          this.relaod = false;
          this.$nextTick(() => {
            this.relaod = true;
          })
        }).catch(() => {

        });

      },
      handleCopy(index) {
        const obj = this.list[index]
        this.$confirm(`是否复制<<${obj.name}>>图层?`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.addCompoment(obj);
        }).catch(() => {

        });
      },
      handleResize({ index, width, height }) {
        const ele = this.list[index].component.option;
        if (['bar', 'progress'].includes(this.activeComponent.prop)) {
          this.$set(ele, 'width', width)
          this.$set(ele, 'height', height)
        }

      },
      handlePostion({ index, left, top }) {
        const ele = this.list[index];
        this.$set(ele, 'left', left)
        this.$set(ele, 'top', top)
      },
      rowSave(row, done) {
        this.activeComponent.option.barColor.push(row);
        done()
      },
      rowDel(row, index) {
        this.activeComponent.option.barColor.splice(index, 1);
      },
      rowUpdate(row, index, done) {
        this.activeComponent.option.barColor.splice(index, 1, row);
        done()
      },
      addCompoment(option) {
        option.left = 0;
        option.top = 0;
        option.zIndex = this.list.length;
        this.list.push(option);
      },
      handleView() {
        this.menuFlag = false;
      },
      handleBuild() {
        this.dialogVisible = true;
        this.$nextTick(() => {
          this.CodeMirrorEditor = CodeMirror.fromTextArea(this.$refs.code, {
            lineNumbers: true,
            mode: 'application/json',
            gutters: ['CodeMirror-lint-markers'],
            theme: 'rubyblue',
            lint: true
          });
          this.CodeMirrorEditor.setValue(JSON.stringify(this.list, null, 2))
        })
      },
    }
  })
</script>

</html>